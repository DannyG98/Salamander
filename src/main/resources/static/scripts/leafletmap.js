var coloradoPrecincts = [
    {
        "type": "Feature",
        "properties": {
            "name": "Precinct 1",
            "density": 49.33,
            "population": 1111,
            "Democratic": 11,
            "Republican": 89,
            "White": 22,
            "Hispanic": 50,
            "AfricanAmerican": 33
        },
        "geometry": {
            "type": "Polygon",
            "coordinates": [
                [
                    [
                        -106.622314453125,
                        40.10328591293439
                    ],
                    [
                        -106.2158203125,
                        40.10328591293439
                    ],
                    [
                        -106.2158203125,
                        40.95501133048621
                    ],
                    [
                        -106.622314453125,
                        40.95501133048621
                    ],
                    [
                        -106.622314453125,
                        40.10328591293439
                    ]
                ]
            ]
        }
    },
    {
        "type": "Feature",
        "properties": {
            "name": "Precinct 2",
            "density": 49.33,
            "population": 2,
            "Democratic": 50,
            "Republican": 50,
            "White": 50,
            "Hispanic": 20,
            "AfricanAmerican": 30
        },
        "geometry": {
            "type": "Polygon",
            "coordinates": [
                [
                    [
                        -106.07299804687499,
                        39.36827914916014
                    ],
                    [
                        -105.29296874999999,
                        39.36827914916014
                    ],
                    [
                        -105.29296874999999,
                        40.88860081193033
                    ],
                    [
                        -106.07299804687499,
                        40.88860081193033
                    ],
                    [
                        -106.07299804687499,
                        39.36827914916014
                    ]
                ]
            ]
        }
    },
    {
        "type": "Feature",
        "properties": {
            "name": "Precinct 3",
            "density": 49.33,
            "population": 1,
            "Democratic": 61,
            "Republican": 39,
            "White": 40,
            "Hispanic": 41,
            "AfricanAmerican": 19
        },
        "geometry": {
            "type": "Polygon",
            "coordinates": [
                [
                    [
                        -105.18310546875,
                        40.3130432088809
                    ],
                    [
                        -102.249755859375,
                        40.3130432088809
                    ],
                    [
                        -102.249755859375,
                        40.84706035607122
                    ],
                    [
                        -105.18310546875,
                        40.84706035607122
                    ],
                    [
                        -105.18310546875,
                        40.3130432088809
                    ]
                ]
            ]
        }
    },
    {
        "type": "Feature",
        "properties": {
            "name": "Precinct 4",
            "density": 49.33,
            "population": 20,
            "Democratic": 41,
            "Republican": 59,
            "White": 70,
            "Hispanic": 30,
            "AfricanAmerican": 0
        },
        "geometry": {
            "type": "Polygon",
            "coordinates": [
                [
                    [
                        -105.10620117187499,
                        39.155622393423215
                    ],
                    [
                        -102.23876953125,
                        39.155622393423215
                    ],
                    [
                        -102.23876953125,
                        40.136890695345905
                    ],
                    [
                        -105.10620117187499,
                        40.136890695345905
                    ],
                    [
                        -105.10620117187499,
                        39.155622393423215
                    ]
                ]
            ]
        }
    },
    {
        "type": "Feature",
        "properties": {
            "name": "Precinct 5",
            "density": 49.33,
            "population": 123,
            "Democratic": 90,
            "Republican": 10,
            "White": 10,
            "Hispanic": 20,
            "AfricanAmerican": 70
        },
        "geometry": {
            "type": "Polygon",
            "coordinates": [
                [
                    [
                        -106.5234375,
                        39.12153746241925
                    ],
                    [
                        -106.12792968749999,
                        39.12153746241925
                    ],
                    [
                        -106.12792968749999,
                        39.96870074491696
                    ],
                    [
                        -106.5234375,
                        39.96870074491696
                    ],
                    [
                        -106.5234375,
                        39.12153746241925
                    ]
                ]
            ]
        }
    },
    {
        "type": "Feature",
        "properties": {
            "name": "Precinct 6",
            "density": 49.33,
            "population": 223,
            "Democratic": 81,
            "Republican": 19,
            "White": 60,
            "Hispanic": 11,
            "AfricanAmerican": 33
        },
        "geometry": {
            "type": "Polygon",
            "coordinates": [
                [
                    [
                        -105.985107421875,
                        39.07037913108751
                    ],
                    [
                        -105.216064453125,
                        39.07037913108751
                    ],
                    [
                        -105.216064453125,
                        39.21523130910491
                    ],
                    [
                        -105.985107421875,
                        39.21523130910491
                    ],
                    [
                        -105.985107421875,
                        39.07037913108751
                    ]
                ]
            ]
        }
    },
    {
        "type": "Feature",
        "properties": {
            "name": "Precinct 7",
            "density": 49.33,
            "population": 223,
            "Democratic": 81,
            "Republican": 19,
            "White": 60,
            "Hispanic": 11,
            "AfricanAmerican": 33
        },
        "geometry": {
            "type": "Polygon",
            "coordinates": [
                [
                    [
                        -105.16113281249999,
                        38.50948995925553
                    ],
                    [
                        -102.1893310546875,
                        38.50948995925553
                    ],
                    [
                        -102.1893310546875,
                        39.05758374935667
                    ],
                    [
                        -105.16113281249999,
                        39.05758374935667
                    ],
                    [
                        -105.16113281249999,
                        38.50948995925553
                    ]
                ]
            ]
        }
    },
    {
        "type": "Feature",
        "properties": {
            "name": "Precinct 8",
            "density": 49.33,
            "population": 223,
            "Democratic": 81,
            "Republican": 19,
            "White": 60,
            "Hispanic": 11,
            "AfricanAmerican": 33
        },
        "geometry": {
            "type": "Polygon",
            "coordinates": [
                [
                    [
                        -107.16064453125,
                        38.792626957868904
                    ],
                    [
                        -106.7156982421875,
                        38.792626957868904
                    ],
                    [
                        -106.7156982421875,
                        40.896905775860006
                    ],
                    [
                        -107.16064453125,
                        40.896905775860006
                    ],
                    [
                        -107.16064453125,
                        38.792626957868904
                    ]
                ]
            ]
        }
    },
    {
        "type": "Feature",
        "properties": {
            "name": "Precinct 9",
            "density": 49.33,
            "population": 223,
            "Democratic": 81,
            "Republican": 19,
            "White": 60,
            "Hispanic": 11,
            "AfricanAmerican": 33
        },
        "geometry": {
            "type": "Polygon",
            "coordinates": [
                [
                    [
                        -108.12744140625,
                        38.09133660751176
                    ],
                    [
                        -107.22656249999999,
                        38.09133660751176
                    ],
                    [
                        -107.22656249999999,
                        40.88860081193033
                    ],
                    [
                        -108.12744140625,
                        40.88860081193033
                    ],
                    [
                        -108.12744140625,
                        38.09133660751176
                    ]
                ]
            ]
        }
    }
]

var floridaPrecincts = [
    {
        "type": "Feature",
        "properties": {
            "name": "Precinct 1",
            "density": 49.33,
            "population": 1111,
            "Democratic": 11,
            "Republican": 89,
            "White": 22,
            "Hispanic": 50,
            "AfricanAmerican": 33
        },
        "geometry": {
            "type": "Polygon",
            "coordinates": [
                [
                    [-82.76000976562501, 29.7596087873038],
                    [-81.31530761718751, 28.51696944040106],
                    [-82.22717285156251, 28.076827124762378],
                    [-83.05664062500001, 29.430029404571762],
                ]
            ]
        }
    },
]

const LeafletMap = {
    // Used for keeping of track what tool is being used
    modes: { default: 0, insert: 1, merge: 2, modify: 3},
    currentMode: 0,
    stateLayer: null,
    districtLayer: null,
    precinctLayer: null,
    tempLayer: null,
    statesGeojson: [],
    districtGeojson: [],
    precinctGeojson: [],
    tempPrecinctGeojson: [],
    infoBox: L.control(),
    states: {},
    districts: {},
    precincts: {},
    ghostCounter: 0,
    currentState: null,
    currentDistrict: null,

    usaCoordinates: [39.51073, -96.4247],
    // The iteractive map that is going to be displayed on the webpage
    map: L.map('mapid', { minZoom: 5, maxZoom: 15, maxBounds: [[20.396308, -135.848974], [49.384358, -55.885444]] }),

    init: function () {
        LeafletMap.map.setView(this.usaCoordinates, 5);
        LeafletMap.initData();
        LeafletMap.initLeafletLayers();
        LeafletMap.initZoomHandlers();
        LeafletMap.initInfoBox();
    },

    initData: function() {
        // TODO
        // Need to request stateObject from server to populate the map with the state borders 
        LeafletMap.statesGeojson = DataHandler.getAllStateData();

        // Create a hashmap that maps precinct canonical names to geojson data
        LeafletMap.precinctGeojson.push(...coloradoPrecincts);
        LeafletMap.precinctGeojson.push(...floridaPrecincts);
        for (var i = 0; i < LeafletMap.precinctGeojson.length; i++) {
            this.precincts[LeafletMap.precinctGeojson[i].properties.name] = LeafletMap.precinctGeojson[i];
        }
    },

    initLeafletLayers: function () {
        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
            id: 'mapbox/streets-v11',
            accessToken: 'pk.eyJ1IjoiZGFuZzk4IiwiYSI6ImNrNmlsbGZqNTAyYzgzZHFtcjczMmI2Z3EifQ.N6aBfLfiwLfyTn_Iz0TvIw'
        }).addTo(this.map);
    },

    initZoomHandlers: function () {
        LeafletMap.map.on('zoomend', function (e) {
            // Display only the state borders when zoomed out too far
            let zoomLevel = LeafletMap.map.getZoom();
            if (zoomLevel <= 6) {
                LeafletMap.enableStateLayer(true);
                LeafletMap.enableDistrictLayer(false);
                LeafletMap.enablePrecinctLayer(false);
                ToolBar.enableAllFilters(true);
                ToolBar.unselectState();
            }     
            console.log("Current Zoom Level =" + zoomLevel)
         });
    },

    initInfoBox: function () {
        // Create an function that creates a information box in the top right corner and populates it with the given props
        LeafletMap.infoBox.update = function (props) {
            // TODO
            // Need to update properties to their correct name in the geojson from server
            Window._div.innerHTML = '<h4>U.S State Data</h4>' + (props ?
                '<b>' + props.displayName + '</b><br />' + 'Democratic: ' + props.elecData.democraticVotes + '%' +
                '</b><br>Republican: ' + props.elecData.republicanVotes + '%' + '</b><br />White: ' + props.demoData.whitePop + '%' +
                '</b><br />Other: ' + props.demoData.otherPop + '%' + '</b><br />African American: '
                + props.demoData.blackPop + '%' + '</b><br />Population:' + props.population
                : 'Hover for more detail');

            //  '<b>' + props.name + '</b><br />' + props.density + ' people / mi<sup>2</sup>'
            //  : 'Hover states for more details');
        };
        LeafletMap.infoBox.onAdd = function (mymap) {
            Window._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
            LeafletMap.infoBox.update();
            return Window._div;
        };
        // Add to the leaflet map
        LeafletMap.infoBox.addTo(LeafletMap.map);

    },

    onEachFeature: function (feature, layer) {
        layer.on({
            mouseover: LeafletMap.highlightFeature,
            mouseout: LeafletMap.resetHighlight,
            click: LeafletMap.onClickHandler
        });
    },

    highlightFeature: function (e) {
        var layer = e.target;

        layer.setStyle({
            weight: 4,
            color: '#1a0aff',
            dashArray: '',
            fillOpacity: 0.2
        });

        if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
            //layer.bringToFront();
        }
        LeafletMap.infoBox.update(layer.feature.properties);
    },

    resetHighlight: function (e) {
        if (LeafletMap.map.hasLayer(LeafletMap.stateLayer)) {
            LeafletMap.stateLayer.resetStyle(e.target);
            LeafletMap.infoBox.update();
        }
        else if (LeafletMap.map.hasLayer(LeafletMap.precinctLayer)) {
            LeafletMap.precinctLayer.resetStyle(e.target);
            LeafletMap.infoBox.update();
        }
        else if (LeafletMap.map.hasLayer(LeafletMap.districtLayer)) {
            LeafletMap.districtLayer.resetStyle(e.target);
            LeafletMap.infoBox.update();
        }
    },

    onClickHandler: function (e) {
        const canonicalName = e.target.feature.properties.canonName;

        // The clicked layer is a state layer
        if (LeafletMap.states[canonicalName] != null) {
            LeafletMap.currentState = canonicalName;
            // Responsible for updating toolbar GUI and updating districtGeoson
            LeafletMap.stateLayerHandler(canonicalName);
            LeafletMap.enableStateLayer(false)
             // Enable all the options in filter dropdown menu
            ToolBar.enableAllFilters(true);
            // Disable district filter 
            let filter = $('#district-filter')[0];
            filter.className = filter.className.replace(/active/g, "");
        }
        // The clicked layer is a district
        else if (LeafletMap.districts[canonicalName] != null) {
            LeafletMap.currentDistrict = canonicalName;
            // Responsible for updating precinctGeoson
            LeafletMap.districtLayerHandler(canonicalName);
            LeafletMap.enableDistrictLayer(false);
            ToolBar.enableAllFilters(true);
            // Disable precinct filter 
            let filter = $('#precinct-filter')[0];
            filter.className = filter.className.replace(/active/g, "");
        }
        LeafletMap.zoomToFeature(e);
        stateChangeHandler(e.target.feature.properties.canonName);
    },

    stateLayerHandler: function(stateCanonName) {
        // Update the states dropdown menu UI
        const statesDropdownElements = $('#states').find(".dropdown-item");
        for (let i = 0; i < statesDropdownElements.length; i++) {
            if (statesDropdownElements[i].text.toLowerCase() == stateCanonName) {
                ToolBar.unselectState();
                statesDropdownElements[i].className += " active";
                // Get district from server
                DataHandler.getDistrictData(LeafletMap.states[stateCanonName].districtCNames);
                break;
            }
        }
    },
    districtLayerHandler: function(districtCanonName) {

    },

    zoomToFeature: function (e) {
        LeafletMap.map.fitBounds(e.target.getBounds());
    },

    panMap: function (lat, long, zoom) {
        LeafletMap.map.setView([lat, long], zoom);
    },
    
    enableStateLayer: function(option) {
        switch(option) {
            case true:
                if (!LeafletMap.map.hasLayer(LeafletMap.stateLayer)) {
                    LeafletMap.stateLayer = L.geoJson(LeafletMap.statesGeojson, 
                        { onEachFeature: LeafletMap.onEachFeature }, 
                        { style: { pmIgnore: true } 
                    }).addTo(LeafletMap.map); }
                break;
            case false:
                if (LeafletMap.map.hasLayer(LeafletMap.stateLayer)) { 
                    LeafletMap.map.removeLayer(LeafletMap.stateLayer); }
                break;
        }
    },

    enableDistrictLayer: function(option) {
        switch(option) {
            case true:
                if (!LeafletMap.map.hasLayer(LeafletMap.districtLayer)) { 
                    LeafletMap.districtLayer = L.geoJson(LeafletMap.districtGeojson, 
                        { onEachFeature: LeafletMap.onEachFeature }, 
                        { style: { pmIgnore: true } 
                    }).addTo(LeafletMap.map).bringToFront(); }
                break;
            case false:
                if (LeafletMap.map.hasLayer(LeafletMap.districtLayer)) { 
                    LeafletMap.map.removeLayer(LeafletMap.districtLayer); }
                break;
        }
    },

    enablePrecinctLayer: function(option) {
        switch(option) {
            case true:
                if (!LeafletMap.map.hasLayer(LeafletMap.precinctLayer)) {
                    LeafletMap.precinctLayer = L.geoJson(LeafletMap.precinctGeojson, 
                        { onEachFeature: LeafletMap.onEachFeature }, 
                        { style: { pmIgnore: false } 
                    }).addTo(LeafletMap.map);
                    LeafletMap.precinctLayer.bringToFront(); }
                if (!LeafletMap.map.hasLayer(LeafletMap.tempLayer)) {
                    LeafletMap.tempLayer = L.geoJson(LeafletMap.tempPrecinctGeojson, 
                        { onEachFeature: LeafletMap.onEachFeature }, 
                        { style: { pmIgnore: false } 
                    }).addTo(LeafletMap.map); }
                break;
                
            case false:
                if (LeafletMap.map.hasLayer(LeafletMap.precinctLayer)) {
                    LeafletMap.map.removeLayer(LeafletMap.precinctLayer); }
                if (LeafletMap.map.hasLayer(LeafletMap.tempLayer)) {
                    LeafletMap.map.removeLayer(LeafletMap.tempLayer); }
                break;
        }
    },

    updatePrecinctLayer: function() {
        if (LeafletMap.map.hasLayer(LeafletMap.precinctLayer)) { 
            LeafletMap.map.removeLayer(LeafletMap.precinctLayer); 
            LeafletMap.precinctLayer = L.geoJson(LeafletMap.precinctGeojson, { onEachFeature: LeafletMap.onEachFeature }, { style: { pmIgnore: false } }).addTo(LeafletMap.map);
        }
    },

    resetMapFunctionalities: function() {
        // Reset all temp variables and revert back to normal map functionality
        switch(LeafletMap.currentMode) {
            case LeafletMap.modes.insert:
                // Need to remove all tempJson precincts from map and empty tempPrecinctGeojson
                if (LeafletMap.map.hasLayer(LeafletMap.tempLayer)) { LeafletMap.map.removeLayer(LeafletMap.tempLayer);}
                LeafletMap.tempPrecinctGeojson = [];
                LeafletMap.tempLayer = null;
                // Refresh the precinct layers
                if (LeafletMap.map.hasLayer(LeafletMap.precinctLayer)) { 
                    LeafletMap.map.removeLayer(LeafletMap.precinctLayer);
                    LeafletMap.precinctLayer = L.geoJson(LeafletMap.precinctGeojson, { onEachFeature: LeafletMap.onEachFeature }, { style: { pmIgnore: false } }).addTo(LeafletMap.map);
                }
                LeafletMap.map.pm.disableDraw();
                break;
            case LeafletMap.modes.modify:
                if (LeafletMap.map.hasLayer(LeafletMap.precinctLayer)) { 
                    LeafletMap.map.removeLayer(LeafletMap.precinctLayer);
                    LeafletMap.precinctLayer = L.geoJson(LeafletMap.precinctGeojson, { onEachFeature: LeafletMap.onEachFeature }, { style: { pmIgnore: false } }).addTo(LeafletMap.map);
                }
                break;
            default:
                console.log("INVALID CURRENT MODE");
        }
        LeafletMap.currentMode = LeafletMap.modes.default;
        ToolBar.toggleEditButtons();
    },
    
}
LeafletMap.init();